<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>AstroServerChecker</title>
        <link rel="stylesheet" href="{{ static_url('css/style.css') }}" />
        <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.css"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <div id="main" class="col-3 mx-auto my-5">
                    <div class="card bg-dark">
                        <div class="card-header">
                            <h2>Astroneer Dedicated Server Checker</h2>
                        </div>
                        <div class="card-body p-0">
                            <form id="checkIPPort">
                                <label for="ip">IP: </label>
                                <input
                                    type="text"
                                    name="ip"
                                    id="ip"
                                    value="{{ clientIP }}"
                                />
                                <label for="port">Port: </label>
                                <input
                                    type="text"
                                    name="port"
                                    id="port"
                                    value="{{ clientPort }}"
                                />
                                <button>Submit</button>
                            </form>
                            <div id="msg" class="p-0">
                                <h5></h5>
                            </div>
                        </div>
                        <div
                            id="data-footer"
                            class="card-footer text-center collapse p-0"
                        >
                            <div class="row text-left m-0">
                                <div class="ml-auto col-6 bg-dark">
                                    <div class="row">
                                        <div class="col-12">Server:</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">Playfab:</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            Server Version:
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">Players:</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">Password:</div>
                                    </div>
                                </div>
                                <div class="mr-auto col-6 bg-dark">
                                    <div class="row">
                                        <div
                                            id="servstatus"
                                            class="col-12"
                                        ></div>
                                    </div>
                                    <div class="row">
                                        <div id="pfstatus" class="col-12"></div>
                                    </div>
                                    <div class="row">
                                        <div
                                            id="servversion"
                                            class="col-12"
                                        ></div>
                                    </div>
                                    <div class="row">
                                        <div
                                            id="servplayers"
                                            class="col-12"
                                        ></div>
                                    </div>
                                    <div class="row">
                                        <div id="servpass" class="col-12"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script
            src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
            integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
            crossorigin="anonymous"
        ></script>
        <script type="application/javascript">
            (function () {
                if ($("#ip").val() == "") {
                    $.getJSON("https://api.ipify.org?format=json", function (
                        json
                    ) {
                        $("#ip").val(json.ip);
                    });
                }
                const statusMsg = (data) => {
                    $("#msg").removeClass(
                        "bg-success bg-danger bg-warning text-light text-dark"
                    );
                    if (data.status) {
                        $("#msg h5").text("Checking...");
                        $("#msg").addClass("bg-warning");
                        $("#msg").addClass("text-dark");
                    } else {
                        if (data.Server && data.Playfab) {
                            $("#msg h5").text("Status: Online");
                            $("#msg").addClass("bg-success");
                            $("#servversion").show();
                            $("#servplayers").show();
                            $("#servpass").show();
                        } else {
                            $("#servversion").hide();
                            $("#servplayers").hide();
                            $("#servpass").hide();
                            if (!data.Server) {
                                $("#msg h5").text("Status: Unreachable");
                                $("#msg").addClass("bg-danger");
                            }
                            if (!data.Playfab) {
                                $("#msg h5").text("Status: Unregistered");
                                $("#msg").addClass("bg-danger");
                            }
                        }
                        if (data.Server) {
                            $("#servstatus").addClass("bg-success");
                            $("#servstatus").addClass("text-dark");
                        } else {
                            $("#servstatus").addClass("bg-danger");
                        }
                        data.Server = data.Server ? "Reachable" : "Unreachable";
                        $("#servstatus").text(data.Server);

                        if (data.Playfab) {
                            $("#pfstatus").addClass("bg-success");
                            $("#pfstatus").addClass("text-dark");
                        } else {
                            $("#pfstatus").addClass("bg-danger");
                        }
                        data.Playfab = data.Playfab
                            ? "Registered"
                            : "Unregistered";
                        $("#pfstatus").text(data.Playfab);

                        if (!data.UpToDate) {
                            data.Version =
                                data.Version +
                                " (Latest: " +
                                data.LatestVersion +
                                ")";
                            $("#servversion").addClass("bg-warning");
                            $("#servversion").addClass("text-dark");
                        }
                        $("#servversion").text(data.Version);

                        $("#servplayers").text(data.PlayerCount);

                        $("#servpass").text(data.Password);

                        $("#data-footer").collapse("show");
                    }
                };
                $("#checkIPPort button").click(function (e) {
                    e.preventDefault();
                    let ip = $("#ip").val();
                    let port = $("#port").val();

                    window.location.href = "?url=" + ip + ":" + port;
                });
                $(document).ready(function (e) {
                    dSend = $("#checkIPPort").serialize();
                    statusMsg({ status: "Checking" });
                    $.ajax({
                        type: "post",
                        url: "/api",
                        dataType: "json",
                        data: dSend,
                        contentType: "application/x-www-form-urlencoded",
                        success: function (result) {
                            console.log(result);
                            statusMsg(result);
                            //alert(result.status);
                        },
                        error: function (result) {
                            console.log(result);
                            statusMsg(result);
                            //alert("Error");
                        },
                    });
                });
            })();
        </script>
    </body>
</html>
